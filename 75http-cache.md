---
title: 75 学习 HTTP 缓存
date: 2021-08-20 19:38:18
tags: [HTTP缓存]
categories: HTTP
---

深入了解 HTTP 缓存。

<!-- more -->


## HTTP缓存

HTTP缓存分为 **强缓存** 和 **协商缓存**。

两者区别在于：

1. 强缓存的缓存命中时，直接读取本地缓存返回响应，不需要与服务端进行通信；
2. 而协商缓存在使用本地缓存时，需要向服务端发送一次 GET 请求，与服务器协商当前的缓存是否过期。

---

### 强缓存

#### expires

expires 是 HTTP1.0 提出的控制缓存的字段。

当服务器返回要强制缓存的资源时，会在响应头中加入 expires 字段，字段的值是一个时间戳。

客户端会保存 expires 的值，当需要进行强缓存时，会比较客户端本地的事件戳和 expires 的时间戳，如果本地时间戳小于 expires 的值，说明缓存有效，命中强缓存，否则缓存无效，重新向服务器发送请求。

**缺陷：**

- 过分依赖客户端的本地时间，如果客户端和服务端时间有偏差或者客户端时间被修改，会导致缓存不正常。



#### cache-control

HTTP1.1 新增了 cache-control 字段用于完善 expires 的功能。

与 expires 不同的是，cache-control 不是指定一个时间戳，而是一个相对时间 max-age，它的单位是秒，表示在多少秒内缓存有效。

cache-control 的属性：

1. no-cache 和 no-store
   - no-cache 表示强制使用协商缓存，不经过强缓存；
   - no-store 表示不使用任何缓存，即每次请求资源都想服务器发送请求；
   - no-cache 和 no-store 是一对互斥的值，不能同时设置。
2. private 和 public
   - public 表示资源既可以被浏览器缓存，也可以被代理服务器缓存；
   - private 表示资源只可以被浏览器缓存，不能被代理服务器缓存；
   - public 和 private 同样是一对互斥的值，不能同时设置。
3. max-age 和 s-maxage
   - max-age 表示浏览器上的缓存的过期时长；
   - s-maxage 表示代理服务器上的缓存的过期时长，仅当设置了 public 属性值时才有效。

**由此可见，cache-control 可以完全作为 expires 的替代方案，而且拥有一些新的特性。expires 目前还存在的唯一理由也许就是考虑到向下兼容。**

---

### 协商缓存

#### last-modified

当服务器返回需要协商缓存的资源时，会在响应头中加上 last-modified 字段，它的值是是一个时间戳，表示资源最后一次修改的时间。

浏览器收到响应后，会保存 last-modified 的值，当下一次访问该资源时，会在请求头中添加 if-modified-since 字段，它的值就是 last-modified 的值。

服务器收到请求后会比较请求资源的当前修改时间戳是否和 if-modified-since 的时间戳相同，如果相同，表示资源没有修改，返回 304 (Not Modified)，浏览器继续使用缓存，否则返回新的资源，状态为 200 。

*这里需要注意的是，协商缓存有效的响应状态码是 304，表示缓存有效应重定向到本地资源；而强缓存有效的响应状态码是 200 。*

**缺陷：**

- last-modified 是根据资源最后修改的时间戳进行判断的，如果资源只是编辑了信息，比如重命名，但内容没有发生改变，这也会导致 last-modified 的变化，这也就会使内容未改变的资源也发生更新，浪费带宽；
- last-modified 的单位是秒，如果文件修改的速度非常快，比如在几百毫秒内完成的修改，那么就无法识别出资源的更新。

#### Etag

为了弥补通过时间戳判断的不足，HTTP1.1 新增了 Etag 头信息，即实体标签（Entity Tag）。

服务器会对不同资源进行哈希运算生成一个字符串，这个字符串类似于文件指纹，只要文件内容发生变化，对应的 Etag 的值就会不同，因此可以通过 Etag 对文件资源进行更精确的变化感知。

当服务器需要返回协商缓存的资源时，会对资源进行哈希运算，生成哈希字符串，并在响应头中添加 Etag 字段，值为这个哈希字符串。

浏览器收到响应后，就会把 Etag 值存储起来，当下一次请求这个资源的时候，会在请求头中添加 if-none-match 字段，值为 Etag 值。

服务器收到请求后，会比对 if-none-match 和 资源当前的 Etag 值，如果相同则命中协商缓存，返回 304，浏览器使用本地缓存，否则返回新的资源，状态码为 200 。

**在协商缓存中，Etag 不是 last-modified 的替代方案，而是一种补充方案，它依然存在一些弊端：**

- 服务器对资源进行哈希运算生成 Etag 需要额外的性能开销，如果资源大，数量多且修改频繁，那么变化影响服务器的性能；
- Etag 字段值的生成分为 **强验证** 和 **弱验证**，强验证能保证文件每个字节都相同，而弱验证生成速度快但无法保证每个字节都相同，所以无法保证协商缓存的有效性验证。

---

### 响应头与请求头

|    响应头     |              请求头              |
| :-----------: | :------------------------------: |
|    expires    | 无（因为强缓存不需要请求服务器） |
| cache-control | 无（因为强缓存不需要请求服务器） |
| last-modified |        if-modified-since         |
|     Etag      |          if-none-match           |



---

### 参考资料

- https://www.yuque.com/docs/share/51c50cef-36e2-4e40-9a6d-c4c0bcc7b2b4
- https://juejin.cn/post/6916157109906341902/#heading-27

